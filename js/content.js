(()=>{"use strict";class e{constructor(){}flush(){let e=this.getContainer();e.querySelectorAll(".order-card.js-order-card,.order.js-order-card").forEach((e=>e.parentElement.removeChild(e))),e.querySelectorAll("script").forEach((e=>e.parentElement.removeChild(e)))}inserts(e){let t=this.getContainer();e.forEach((e=>{t.appendChild(e)}))}getContainer(){return document.querySelector("#ordersContainer,.js-yo-main-content")}getAppendTarget(){}hidePagination(){try{this.getContainer().querySelector(".a-pagination").style.display="none"}catch(e){}}}class t{constructor(e=""){this._src=e}set src(e){this._src=e}async exec(){return new Promise((e=>{let t=this._src,r=document.createElement("iframe"),o=n=>{if(n.data.hasOwnProperty("href")&&n.data.href.replace(location.origin,"")===t&&n.data.state){window.removeEventListener("message",o,!1),document.body.removeChild(r);let t=this.parser(n.data.nodeStr),i=n.data.lastIndex;e({productNodes:t,lastIndex:i})}};window.addEventListener("message",o,!1),r.src=t,document.body.appendChild(r)}))}parser(e){let t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll(".order.js-order-card"))}}class r{static sleep(e=1e3){return new Promise((t=>setTimeout(t,e)))}}class o{constructor(){this._inserter=null,this._loader=null,this._year="",this._lastIndex=0,this._logger=null,this._progress=null}set logger(e){this._logger=e}get inserter(){return this._inserter}set inserter(e){this._inserter=e}get loader(){return this._loader}set loader(e){this._loader=e}get year(){return this._year}set year(e){this._year=e}get lastIndex(){return this._lastIndex}set lastIndex(e){this._lastIndex=e}get progress(){return this._progress}set progress(e){this._progress=e}async exec(){let e=this._inserter,o=this._logger;this._progress.show(),o.log("現在の表示をフラッシュします"),e.flush(),o.log("現在の表示をフラッシュしました");let n=new t,i=this._year;n.src=this.createAccessURL(i),this._progress.start(300),o.log(`選択された[${i}]の1ページ目を取得します`);let{productNodes:s,lastIndex:l}=await n.exec(i);o.log(`選択された[${i}]の1ページ目を取得しました。最終ページは${l}です。`),this._lastIndex=l,this._progress.start(l),this._progress.update(1),e.inserts(s),o.log(`選択された[${i}]の1ページ目のデータを挿入します`);let a=this.createAccessURLs(i,this._lastIndex);o.log(`最終ページをもとに[${i}]アクセスするURLを生成します.`),this._progress.end=this._lastIndex;for(let t=0;t<a.length;t+=3){let n=this.createGetViews(3);n.forEach(((e,r)=>{a[t+r]?e.src=a[t+r]:n[r]=null}));let i=[];n.forEach((e=>{e&&i.push(e.exec())})),o.log(`${t+1}件目～${t+i.length}件目`),o.log(`並行アクセス(iframe)数は,${i.length}件`),(await Promise.all(i)).forEach((t=>{console.log(t),e.inserts(t.productNodes)})),this._progress.update(t+i.length),o.log("取得挿入完了。スリープします。"),await r.sleep(300),o.log("スリープ終了。次の3件の処理に移ります。")}this._progress.update(l),this._progress.hide(),o.log("全件投入完了しました。")}createGetViews(e){let r=[];for(;r.length<e;)r.push(new t);return r}createAccessURLs(e="",t=1){let r=[];for(let o=1;o<=t;o++)r.push(this.createAccessURL(e,o));return r}createAccessURL(e="",t=0){let r=this.accessURL({orderFilter:`year-${e}`});return t&&(r+="&startIndex="+10*t),r}accessURL(e={}){let t="/gp/your-account/order-history",r=[];return Object.keys(e).forEach((t=>{r.push(`${t}=${e[t]}&`)})),r.length&&(t+="?",t+=r.join("&")),t}}class n{constructor(){this._field=null}set field(e){this._field=e}log(e){let t=document.createElement("p");t.innerHTML=e,t.style.margin="0",t.style.paddingBottom=".15em",t.style.color="white",t.style.fontSize="12px",this._field.prepend(t)}}class i{constructor(){this._isLock=!1}get isLock(){return this._isLock}lock(){this._isLock=!0}unlock(){this._isLock=!1}}class s extends i{constructor(){super(),this._lockTargetSelectors=[],this._logger=null}set logger(e){this._logger=e}set lockTargetSelectors(e){this._lockTargetSelectors=e}lock(){super.lock(),this._logger.log("ロックします"),this._lockTargetSelectors.forEach((e=>{document.querySelectorAll(e).forEach((e=>{e.setAttribute("disabled","disabled")}))}))}unlock(){super.unlock(),this._logger.log("アンロックします"),this._lockTargetSelectors.forEach((e=>{document.querySelectorAll(e).forEach((e=>{e.removeAttribute("disabled","disabled")}))}))}}class l{constructor(e){this._start=0,this._end=10,this._progressElement=e}get start(){return this._start}set start(e){this._start=e}get end(){return this._end}set end(e){this._end=e}show(){this._progressElement.style.display="block"}hide(){this._progressElement.style.display="none"}start(e){this._end=e,this._progressElement.max=this._end}update(e){this._progressElement.value=e}stop(){}flush(){}}const a="amazon";async function c(e="https://www.amazon.co.jp/documents/download/812ccde1-8a52-4f91-a4e3-8d0a9638bc56/invoice.pdf",t={}){let r=await fetch(e);return await r.arrayBuffer()}function d(e,t){const r=URL.createObjectURL(new Blob([e])),o=document.createElement("a");o.href=r,o.setAttribute("download",`${t}.pdf`),document.body.appendChild(o),o.click(),URL.revokeObjectURL(o.href),document.body.removeChild(o)}!function(){if(!(location.pathname.match("/gp/your-account/order-history")||location.pathname.match("/gp/css/order-history")||location.pathname.match("/your-orders/orders")))return;let t=new n;const i=new s;i.logger=t;let h=document.createElement("progress");const u=new l(h);u.hide();const p="ecInvoiceExec",g="ecYearProductListExec",f="ecDigitalChoice",m="ecLogMsgField",y="ecPdfGetAndDownload",v="ecProgressBarWrap";i.lockTargetSelectors=[`#${p}`,`#${g}`,`#${f}`,`#${y}`];let _=!1,b=function(){let e=document.createElement("div"),t=document.createElement("select");t.id=g,t.innerHTML='<option value="">選択してください</option>',function(){let e=document.querySelector("#orderFilter,#time-filter");if(!e)return[];let t=e.cloneNode(!0).querySelectorAll('[value^="year-"]');return t.forEach((e=>e.removeAttribute("selected"))),[t[0],t[1]]}().forEach((e=>t.appendChild(e))),t.value="";let r=e.cloneNode();r.innerHTML="<span>表示する年を選択：</span>",r.appendChild(t);let o="#8effd9",n="#ccc";return e.innerHTML=`\n        <div style="padding-bottom: .5em;margin-bottom: .5em;border: solid 2px ${o};">\n            <h3 style="padding: 3px;background-color: ${o};margin-bottom: 9px;border-bottom: solid 2px ${n};">ECダウンローダーコントロール</h3>\n            <div style="padding: 6px 0;">\n            <div style="display: flex;gap: .5em">\n                <div>\n                   ${r.innerHTML}\n                </div>\n                <button id="${p}">\n                ページに表示された注文情報のインボイスデータを作る\n                </button>\n                <div>\n                <label><input type="checkbox" id="${f}">デジタルを含める</label>\n                </div>\n                <div id="${v}">\n\x3c!--                <label><input type="checkbox" id="${y}" checked="checked">PDF取得とダウンロードを同時に行う</label>--\x3e\n                </div>\n            </div>\n            <div style="border: inset 1px ${n};">\n            <p style="margin: 0;border-bottom: solid 2px ">ログメッセージ:</p>\n            <div id="${m}" style="padding:.25em; max-height: 3em;overflow-y: scroll;width: 100%;background-color: black;color: white">\n            \n            </div>\n            </div>\n            </div>\n        </div>\n        `,e.children[0]}();async function $(e){if(e.target.closest(`#${p}`)){if(i.isLock)return;return i.lock(),async function(e){if(!e.target.closest(`#${p}`))return;let t="PDF取得とダウンロードを同時に行います";L(t),L(`デジタル${_?"を含んだ":"を含まない"}商品のデータを取得します...`);let o=_?I():I().filter((e=>!e.isDigital));L(`対象は${o.length}件です`);let n=[];for(const e of o){if(e){L(`注文番号${e.no}の処理を開始します`);let t,r=`amazon_${e.date}_${e.no}`,o=!1,i={ecName:a,orderNumber:e.no,type:"get-ec-pdf-data"},s={isQualifiedInvoice:!0,isCreateInvoicePDF:!0,qualifiedInvoiceReason:"",sellerContactURLs:[],invoiceList:[]},l={isQualifiedInvoice:!0,isCreateInvoicePDF:!0,qualifiedInvoiceReason:"",sellerContactURL:"",sellerURL:"",isCachePDF:!1,invoiceId:"",fileIdx:0},h=await chrome.runtime.sendMessage(i);if(h.state){L("キャッシュに存在していたため、キャッシュデータを利用します。");let e=h.data;s=h.data.param,e.pdfStrs.forEach(((e,r)=>{let o=`tmp_${h.data.fileName}${r>1?r-1:""}`;t=function(e){const t=window.atob(e),r=t.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=t.charCodeAt(e);return o.buffer}(e),t&&d(t,o),t=""}))}else{let n=`https://www.amazon.co.jp${e.invoiceData.url}`;L("PDFが存在するか確認します...");let i=await fetch(n),h=await i.text(),u=(new DOMParser).parseFromString(h,"text/html"),p=Array.from(u.querySelectorAll('.invoice-list a[href$="invoice.pdf"]'));if(p.length){L(`${e.no}のオーダーは${p.length}件データが見つかりました`);let n=[];-1!==u.body.innerHTML.indexOf("help/contact/contact.html")&&(n=Array.from(u.body.querySelectorAll('[href*="help/contact/contact.html"]')),n.forEach((e=>s.sellerContactURLs.push(e.href))));let i=[];for(let e=0;e<p.length;e++){let o=p[e].href,n=e+1,a=JSON.parse(JSON.stringify(l));s.invoiceList.push(a),a.fileIdx=n;try{L(`PDF情報${n}番目の取得を開始します`),t=await c(o),L("PDF情報を取得しました");let e=function(e){let t="";const r=new Uint8Array(e),o=r.byteLength;for(let e=0;e<o;e++)t+=String.fromCharCode(r[e]);return window.btoa(t)}(t);i.push(e);let l={type:"pdf-decode",pdfStr:e};L("PDF情報を解析します");let h=await chrome.runtime.sendMessage(l);a.isQualifiedInvoice=h.isInvoice,s.isCreateInvoicePDF&=h.isInvoice,s.isCreateInvoicePDF=Boolean(s.isCreateInvoicePDF),a.invoiceId=h.invoiceId,L("PDF情報を解析が終了しました"),t&&d(t,`${r}${n>1?"-"+(n-1):""}`),console.log(h)}catch(e){L("PDF情報取得時にエラーが発生し取得できませんでした。"),a.qualifiedInvoiceReason="取得エラー"}}L("PDF情報をキャッシュします");let h=e.no;s.isCreateInvoicePDF=!0,s.qualifiedInvoiceReason="作成";let g={ecName:a,orderNumber:e.no,type:"set-ec-pdf-data",pdfStrs:i,fileName:r,isInvoice:o,param:s};chrome.runtime.sendMessage(g,(()=>{L(`[${h}]のPDF情報のキャッシュが完了しました`)}))}else{s.isCreateInvoicePDF=!1,s.isQualifiedInvoice=!1,u.querySelectorAll("a");let e=Array.from(u.querySelectorAll("a")).find((e=>-1!==e.textContent.indexOf("領収書／購入明細書がご利用になれません。")));s.qualifiedInvoiceReason=e?"未発送・会計処理未済の注文もしくは、電子マネーの注文":"領収書の発行しか出来ず、適格請求書・支払い明細が取得できない注文",L(`${s.qualifiedInvoiceReason}`)}}n.push(x(e,s))}await r.sleep(500),L(`${e.no}の処理が終了しました`)}L(`デジタル${_?"を含んだ":"を含まない"}商品のデータ${o.length}件の処理が終了しました`),L("結果ページを開きます。"),chrome.runtime.sendMessage({type:"invoice-result",site:"Amazon",data:n})}(e).then((()=>{})).finally((()=>{i.unlock()}))}}async function w(r){if(i.isLock)return;let n=null;r.target.closest(`#${g}`)?n=async function(r){let n=r.target.closest(`#${g}`).value;if(!n)return;n=n.trim().replaceAll(/[^0-9]/gi,"");try{document.querySelector(".a-pagination").style.display="none"}catch(e){}let i=new o;return i.year=n,i.inserter=new e,i.logger=t,i.progress=u,await i.exec()}(r):r.target.closest(`#${f}`)&&(n=async function(e){let t=e.target.closest(`#${f}`);_=t.checked}(r)),n&&(i.lock(),n.finally((()=>{u.hide(),i.unlock()})))}function x(e,t){return{orderNumber:e.no,date:e.date,price:e.price.total,isDigital:e.isDigital,productDataList:e.title,isMultipleOrder:e.title.length>1,isQualifiedInvoice:t.isQualifiedInvoice,isCreateInvoicePDF:t.isCreateInvoicePDF,qualifiedInvoiceReason:t.qualifiedInvoiceReason,sellerContactURLs:t.sellerContactURLs,invoiceId:t.invoiceId,sellerURL:t.sellerURL,sellerURLs:t.sellerURLs,isCachePDF:t.isCachePDF,invoiceList:t.invoiceList}}function L(e){t.log(e)}function I(){let e=Array.from(document.querySelectorAll(".js-order-card")).filter((e=>!e.parentElement.classList.contains("js-order-card"))),t=[];return e.forEach((e=>{let r=function(e){let t={no:"",title:[],date:"",price:{total:""},invoiceData:{},isDigital:!1};t.no=e.querySelector('.yohtmlc-order-id .value,.yohtmlc-order-id [dir="ltr"]').textContent.trim();let r=Array.from(e.querySelectorAll("a[href]")).filter((e=>e.href.match(/\/[A-Z,0-9]{10}[/|?]/))),o=r.filter((e=>!e.querySelector("img"))),n=r.filter((e=>e.querySelector("img")));o.forEach(((e,r)=>{let o=e.href.match(/\/[A-Z,0-9]{10}[/|?]/)[0].replaceAll("/","").replaceAll("?",""),i=e.href,s=e.textContent,l=n[r].querySelector("img"),a=l.getAttribute("data-src")?l.getAttribute("data-src"):l.getAttribute("src");t.title.push({asin:o,href:i,title:s,imgSrc:a})})),t.price.total=e.querySelector(".yohtmlc-order-total .value,.yohtmlc-order-total").textContent.trim(),t.date=Array.from(e.querySelectorAll(".order-header span,.order-info span")).find((e=>e.textContent.trim().match(/[0-9]{4}年[0-9]{1,2}月[0-9]{1,2}日/))).textContent.trim();try{t.invoiceData=JSON.parse(Array.from(e.querySelectorAll(".order-info .yohtmlc-order-level-connections [data-a-popover],.order-header .yohtmlc-order-level-connections [data-a-popover]")).filter((e=>~e.textContent.indexOf("領収書")))[0].getAttribute("data-a-popover"))}catch(e){return L(`${t.no}は領収書が有りません`),null}return t.isDigital=Boolean(t.no.match(/^D/)),t}(e);r&&t.push(r)})),console.log(t),t}document.querySelector("#controlsContainer,.page-tabs").prepend(b),b.querySelector(`#${v}`).appendChild(h),t.field=document.getElementById(m),function(){let e=$,t=w;document.body.addEventListener("click",e),document.body.addEventListener("change",t)}()}()})();